<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <!-- Importa html2canvas para capturar o preview como imagem -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Posts - TJ-PI</title>
    <link rel="stylesheet" href="estilos.css">
    <link rel="icon" type="image/png" href="imagens/icon.png">
</head>

<body>
    <div class="container">
        <!-- Painel de Configuração -->
        <div class="panel">
            <h1>📝 Configurar Notícia</h1>

            <div class="form-group">
                <label>1. Imagem da Notícia</label>
                <div class="file-upload" id="fileUpload">
                    <div id="uploadText">📸 Clique ou arraste uma imagem aqui</div>
                    <input type="file" id="imageInput" accept="image/*" style="display:none">
                </div>
            </div>

            <div class="form-group">
                <label>2. Texto da Notícia</label>
                <textarea id="textoNoticia" placeholder="Digite o texto da notícia aqui..."></textarea>
            </div>

            <!-- Seletor de cor sólida -->
            <div class="form-group">
                <label>3. Selecionar cor</label>
                <div id="colorSelector" style="display: flex; gap: 16px; align-items: center;">
                    <div class="color-circle selected" data-color="#48bb78" title="Verde" style="background:#48bb78;">
                    </div>
                    <div class="color-circle" data-color="#667eea" title="Azul" style="background:#667eea;"></div>
                    <div class="color-circle" data-color="#ffb703" title="Amarelo" style="background:#ffb703;"></div>
                    <div class="color-circle" data-color="#e63946" title="Vermelho" style="background:#e63946;"></div>
                    <div class="color-circle" data-color="#6d597a" title="Roxo" style="background:#6d597a;"></div>
                </div>
            </div>

            <button class="btn" id="downloadBtn">⬇️ Baixar Imagem (STORIES)</button>
        </div>

        <!-- Painel de Preview -->
        <div class="panel">
            <div class="layout-toggle">
                <button class="layout-btn active" id="btnStories">STORIES</button>
                <button class="layout-btn" id="btnFeed">FEED</button>
            </div>

            <div class="post-preview" id="preview"></div>
            <!-- A imagem será inserida via JS dentro do preview -->
        </div>
    </div>

    <script>
        const btnStories = document.getElementById('btnStories');
        const btnFeed = document.getElementById('btnFeed');
        const preview = document.getElementById('preview');
        const downloadBtn = document.getElementById('downloadBtn');
        const fileUpload = document.getElementById('fileUpload');
        const imageInput = document.getElementById('imageInput');
        const uploadText = document.getElementById('uploadText');
        const textoNoticia = document.getElementById('textoNoticia');

        // Atualiza o conteúdo do elemento .titulo-noticia com o texto do textarea
        function syncTituloNoticia(text) {
            let tituloEl = preview.querySelector('.titulo-noticia');
            if (!tituloEl) return;
            tituloEl.textContent = text || '';
        }

        if (textoNoticia) {
            textoNoticia.addEventListener('input', (e) => {
                syncTituloNoticia(e.target.value);
            });
        }

        window.__bgColor = '#48bb78'; // cor inicial
        const colorSelector = document.getElementById('colorSelector');

        // função para escurecer cor do cabeçalho
        function darkenHex(hex, factor) {
            const h = hex.replace('#', '');
            const r = parseInt(h.substring(0, 2), 16);
            const g = parseInt(h.substring(2, 4), 16);
            const b = parseInt(h.substring(4, 6), 16);

            const nr = Math.max(0, Math.floor(r * (1 - factor)));
            const ng = Math.max(0, Math.floor(g * (1 - factor)));
            const nb = Math.max(0, Math.floor(b * (1 - factor)));

            return `rgb(${nr}, ${ng}, ${nb})`;
        }

        // cor sólida + textura
        function ensureBgDiv() {
            let bgDiv = preview.querySelector('.bg-color');
            if (!bgDiv) {
                bgDiv = document.createElement('div');
                bgDiv.className = 'bg-color';
                // colocar no início do preview para ficar atrás de outros elementos
                preview.insertBefore(bgDiv, preview.firstChild);
            }
            return bgDiv;
        }

        // aplica a cor atual na camada .bg-color
        function applyBgToBgDiv() {
            const bgDiv = ensureBgDiv();
            // usamos a cor sólida como background-color; a textura está no ::after
            bgDiv.style.background = window.__bgColor;
        }

        function inserirLogo() {
            let logoImg = preview.querySelector('.logo');
            if (!logoImg) {
                logoImg = document.createElement('img');
                logoImg.src = 'imagens/logo_tjpi.png';
                logoImg.alt = 'Logo TJ-PI';
                logoImg.className = 'logo';
                preview.appendChild(logoImg);
            }
        }

        // Função de inicialização
        function initializePreview() {
            if (!preview) return;

            // 1. Aplica cor inicial
            applyBgToBgDiv();
            preview.style.background = 'transparent';

            // 2. Inserir logo
            inserirLogo();

            // 3. Atualiza layout (stories por padrão) para incluir noticia-vazado
            updatePreviewLayout();
        }

        // Posiciona o cabeçalho e título com base no container de imagem/fundo
        function posicionarTitulo() {
            const rect = preview.querySelector('.cabecalho');
            const tituloEl = preview.querySelector('.titulo-noticia');
            const imgContainer = preview.querySelector('.img-container');

            if (!rect || !tituloEl) return;

            let referenceElement = imgContainer;

            if (!referenceElement) {
                const fixedTop = 25; // Distância fixa do topo (ajustável)
                rect.style.top = `${fixedTop}px`;
                tituloEl.style.top = `${fixedTop + rect.offsetHeight + 10}px`;
                return;
            }

            // Se houver imagem carregada, a lógica de posicionamento é diferente
            requestAnimationFrame(() => {
                const imgEl = referenceElement.querySelector('img');

                const imgRect = imgEl.getBoundingClientRect();
                const previewRect = preview.getBoundingClientRect();

                // posição cabeçalho
                const bottomY = imgRect.bottom - previewRect.top;
                const topPos = bottomY - 12.5; // 12.5px para centralizar na "linha" do recorte da imagem (pode variar)

                rect.style.top = `${topPos}px`;
                tituloEl.style.top = `${topPos + rect.offsetHeight + 10}px`;

            });
        }

        // lógica selecionar cor
        colorSelector.addEventListener('click', (e) => {
            const circle = e.target.closest('.color-circle');
            if (!circle) return;

            window.__bgColor = circle.dataset.color;

            // Atualiza aparência dos círculos
            document.querySelectorAll('.color-circle').forEach(c => {
                c.classList.remove('selected');
                c.style.border = '3px solid transparent';
            });
            circle.classList.add('selected');
            circle.style.border = '3px solid #00000033';

            // Atualiza cor no preview e na div interna
            if (preview) applyBgToBgDiv();
            if (preview) preview.style.background = 'transparent';

            // Atualiza cor do cabeçalho
            const overlay = document.querySelector('.cabecalho');
            if (overlay) overlay.style.background = darkenHex(window.__bgColor, 0.18);
        });


        // Download
        downloadBtn.addEventListener('click', async () => {
            // Verifica se há uma imagem carregada (container da imagem) ou pelo menos o fundo (bg-color)
            const hasContent = preview.querySelector('.img-container') || preview.querySelector('.bg-color');
            if (!hasContent) {
                alert('O preview está vazio. Adicione uma imagem ou recarregue a página.');
                return;
            }

            try {
                const canvas = await html2canvas(preview, { useCORS: true, scale: 2, height: preview.offsetHeight - 1});
                const link = document.createElement('a');
                link.download = downloadBtn.textContent.includes('FEED') ? 'post-feed.png' : 'post-stories.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch (err) {
                console.error('Erro ao gerar imagem com html2canvas:', err);
                alert('Erro ao gerar a imagem. Abra o console do navegador para mais detalhes.');
            }
        });

        // Alterna layout
        btnStories.addEventListener('click', () => {
            btnStories.classList.add('active');
            btnFeed.classList.remove('active');
            preview.classList.remove('feed');
            downloadBtn.textContent = '⬇️ Baixar Imagem (STORIES)';
            updatePreviewLayout();
            posicionarTitulo(); // Reposiciona elementos
        });
        btnFeed.addEventListener('click', () => {
            btnFeed.classList.add('active');
            btnStories.classList.remove('active');
            preview.classList.add('feed');
            downloadBtn.textContent = '⬇️ Baixar Imagem (FEED)';
            updatePreviewLayout();
            posicionarTitulo(); // Reposiciona elementos
        });

        // Upload
        fileUpload.addEventListener('click', () => imageInput.click());
        fileUpload.addEventListener('dragover', e => { e.preventDefault(); fileUpload.style.background = '#e6fffa'; });
        fileUpload.addEventListener('dragleave', e => { e.preventDefault(); fileUpload.style.background = '#f7fafc'; });
        fileUpload.addEventListener('drop', e => {
            e.preventDefault();
            fileUpload.style.background = '#f7fafc';
            const file = e.dataTransfer.files[0];
            if (file) handleImage(file);
        });
        imageInput.addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) handleImage(file);
        });

        // Mostra imagem + fundo sólido + logo
        function handleImage(file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                // Remove container de imagem existente, se houver
                const existingContainer = preview.querySelector('.img-container');
                if (existingContainer) existingContainer.remove();

                preview.style.alignItems = 'flex-start';

                // Container para a imagem da notícia
                const container = document.createElement('div');
                container.className = 'img-container';
                container.style.width = '100%';
                container.style.height = '100%';
                container.style.display = 'flex';
                container.style.flexDirection = 'column';
                container.style.position = 'relative';

                const img = document.createElement('img');
                img.src = e.target.result;
                img.alt = 'Preview da imagem';
                img.style.width = '100%';
                img.style.objectFit = 'contain';
                img.style.objectPosition = 'top';
                img.style.flexShrink = '0';

                img.onload = function () {
                    // Criar o cabeçalho
                    let rect = preview.querySelector('.cabecalho');
                    if (!rect) {
                        rect = document.createElement('div');
                        rect.className = 'cabecalho';
                        preview.appendChild(rect);
                    }
                    rect.style.background = darkenHex(window.__bgColor, 0.18);

                    // Criar o título
                    let tituloEl = preview.querySelector('.titulo-noticia');
                    if (!tituloEl) {
                        tituloEl = document.createElement('div');
                        tituloEl.className = 'titulo-noticia';
                        tituloEl.textContent = '';
                        preview.appendChild(tituloEl);
                    }

                    // sincroniza com o texto atual do textarea
                    syncTituloNoticia(textoNoticia ? textoNoticia.value : '');

                    // Posiciona o cabeçalho e título agora que existem e a imagem está pronta
                    posicionarTitulo();
                };

                container.appendChild(img);
                // Inserir o container antes dos elementos estruturais (logo, cabecalho, titulo-noticia)
                // mas depois da bg-color, o z-index no css já deve resolver a ordem visual
                const bgDiv = preview.querySelector('.bg-color');
                if (bgDiv) {
                    preview.insertBefore(container, bgDiv.nextSibling);
                } else {
                    preview.appendChild(container);
                }

                uploadText.textContent = 'Imagem carregada! Clique ou arraste para alterar.';
            };
            reader.readAsDataURL(file);
        }

        // Atualiza elementos dependentes do tipo de layout (stories vs feed)
        function updatePreviewLayout() {
            // garante que exista o preview e o logo
            if (!preview) return;

            const isFeed = preview.classList.contains('feed');

            // elemento imagem extra (noticia-vazado)
            let extra = preview.querySelector('.noticia-vazado');

            // STORIES: inserir imagem extra se não existir
            if (!isFeed) {
                extra = document.createElement('img');
                extra.src = 'imagens/noticia_vazado.png';
                extra.className = 'noticia-vazado';
                preview.appendChild(extra);

                const logo = preview.querySelector('.logo');
                logo.style.bottom = '110px';
            } else {
                extra.remove(); // remover notícia vazado
                const logo = preview.querySelector('.logo');
                logo.style.bottom = '30px'; // ajustar altura logo
            }
        }

        // --- CHAMADA DE INICIALIZAÇÃO NO FINAL DO SCRIPT ---
        initializePreview();
    </script>

</body>

</html>